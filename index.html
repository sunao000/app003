<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>拡張版ルート案内</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<style>
  #map { height: 500px; width: 100%; }
  #controls { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
  #pointList { list-style: none; padding: 0; margin: 0; }
  #pointList li {
    padding: 4px; border: 1px solid #ccc; margin-bottom: 4px;
    background: #fafafa; display: flex; justify-content: space-between; align-items: center;
    cursor: grab;
  }
  #searchResults { list-style: none; max-height: 120px; overflow-y: auto; border: 1px solid #ccc; padding: 0; margin: 4px 0; }
  #searchResults li { padding: 4px; cursor: pointer; }
  #searchResults li:hover { background: #eee; }
  .legend { display:flex; gap: 10px; margin:10px 0; }
  .legend span { display:inline-block; padding-left:20px; background-repeat:no-repeat; background-position:left center; }
  .legend-blue { background:url('https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png') no-repeat left center; }
  .legend-red { background:url('https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png') no-repeat left center; }
  .legend-orange { background:url('https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png') no-repeat left center; }
  .legend-gray { background:url('https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png') no-repeat left center; }
</style>
</head>
<body>

<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:240px">
  <button id="searchBtn">検索</button>
  <button id="geoBtn">現在地追加</button>
  <button id="drawBtn">ルート表示</button>

  <select id="profileSelect">
    <option value="foot-walking">徒歩</option>
    <option value="driving-car">車</option>
    <option value="cycling-road">自転車（ロード）</option>
    <option value="cycling-regular">自転車（一般）</option>
  </select>

  <label><input type="checkbox" id="nearbyOnly">近くの場所のみ検索</label>
  <label>休憩 <input id="restInt" type="number" value="60" min="10" step="5" style="width:60px">分ごと</label>
  <label><input type="checkbox" id="trackToggle">リアルタイム追跡</label>
</div>

<ul id="searchResults"></ul>
<ul id="pointList"></ul>
<div class="legend">
  <span class="legend-blue">出発地</span>
  <span class="legend-red">目的地</span>
  <span class="legend-orange">実 POI 休憩</span>
  <span class="legend-gray">仮休憩</span>
</div>
<div id="map"></div>

<div id="summary"></div>
<canvas id="distanceChart" width="400" height="200"></canvas>
<button id="downloadPng">グラフPNG</button>
<button id="downloadCsv">CSV出力</button>
<div id="progressStatus"></div>

<script>
/* ===== 0. 定数 ===== */
const apiKey = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9'; // ORS APIキー
const ORS_ROOT = 'https://api.openrouteservice.org';
const PROXY    = 'https://corsproxy.io/?';
const REST_POI_IDS = [533,532,414]; // コンビニ・スーパー・道の駅
const REST_RADIUS  = 1000;

/* ===== 1. 地図初期化 ===== */
const map = L.map('map').setView([35.681236, 139.767125], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {attribution:'© OpenStreetMap contributors'}).addTo(map);

let points = [];  // 登録地点
let routeLayer, poiLayer, restLayer;
let watchId = null; // GeolocationウォッチID

/* ===== 2. DOM参照 ===== */
const $ = id => document.getElementById(id);
const pointList = $('pointList');

/* ===== 3. 地点リスト管理 (Sortable.js) ===== */
Sortable.create(pointList, {
  onEnd: function () {
    const newPoints = [];
    pointList.querySelectorAll('li').forEach(li => {
      const idx = li.getAttribute('data-idx');
      newPoints.push(points[idx]);
    });
    points = newPoints;
    refreshList();
  }
});
function refreshList() {
  pointList.innerHTML = '';
  points.forEach((p, i) => {
    const li = document.createElement('li');
    li.setAttribute('data-idx', i);
    li.textContent = p.name;
    const del = document.createElement('button');
    del.textContent = '×';
    del.onclick = () => { points.splice(i,1); refreshList(); };
    li.appendChild(del);
    pointList.appendChild(li);
  });
}

/* ===== 4. 地名検索 (最大10件) ===== */
$('searchBtn').onclick = () => {
  const q = $('placeInput').value.trim();
  if (!q) return;
  let url = `https://nominatim.openstreetmap.org/search?format=json&limit=10&q=${encodeURIComponent(q)}`;
  if ($('nearbyOnly').checked && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      url += `&viewbox=${pos.coords.longitude-0.05},${pos.coords.latitude+0.05},${pos.coords.longitude+0.05},${pos.coords.latitude-0.05}&bounded=1`;
      fetchNominatim(url);
    });
  } else {
    fetchNominatim(url);
  }
};
function fetchNominatim(url) {
  fetch(url).then(r=>r.json()).then(data => {
    const list = $('searchResults');
    list.innerHTML='';
    data.forEach(d => {
      const li = document.createElement('li');
      li.textContent = d.display_name;
      li.onclick = () => {
        points.push({name:d.display_name, lat:+d.lat, lon:+d.lon});
        refreshList();
        list.innerHTML='';
        $('placeInput').value='';
      };
      list.appendChild(li);
    });
  });
}

/* ===== 5. 現在地追加 ===== */
$('geoBtn').onclick = () => {
  if (!navigator.geolocation) return alert('Geolocation未対応');
  navigator.geolocation.getCurrentPosition(pos => {
    points.push({name:'現在地', lat:pos.coords.latitude, lon:pos.coords.longitude});
    refreshList();
  });
};

/* ===== 6. リアルタイムトラッキング ===== */
$('trackToggle').onchange = () => {
  if ($('trackToggle').checked) {
    if (!navigator.geolocation) return alert('Geolocation未対応');
    watchId = navigator.geolocation.watchPosition(pos => {
      const current = points.find(p=>p.name==='現在地');
      if (current) {
        const dist = L.latLng(current.lat,current.lon)
                       .distanceTo([pos.coords.latitude,pos.coords.longitude]);
        if (dist > 50) {
          current.lat = pos.coords.latitude;
          current.lon = pos.coords.longitude;
          refreshList();
          drawRoute();
        }
      }
    });
  } else {
    if (watchId) navigator.geolocation.clearWatch(watchId);
  }
};

/* ===== 7. ORSルート描画 ===== */
$('drawBtn').onclick = drawRoute;

async function drawRoute(){
  if (points.length < 2) { alert('2地点以上必要'); return; }

  const coords = points.map(p => [p.lon, p.lat]);
  const profile = $('profileSelect').value;

  clearLayers();

  if (points.length === 2) {
    // 代替ルート3本
    const altUrl = `${ORS_ROOT}/v2/directions/${profile}/geojson?alternative_routes=${encodeURIComponent(JSON.stringify({target_count:3}))}`;
    const res = await fetch(PROXY+altUrl,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':apiKey},
      body: JSON.stringify({coordinates:coords,extra_info:["steepness"]})
    });
    if (!res.ok) return alert('ORS error');
    const data = await res.json();
    const routes = data.features;
    let bestIdx = 0;
    let bestScore = Infinity;
    routes.forEach((r,i)=>{
      const score = calcSteepnessScore(r.properties.extras.steepness.values);
      if(score < bestScore){bestScore=score; bestIdx=i;}
    });
    routes.forEach((r,i)=>{
      const style = (i===bestIdx)?{color:'#00f',weight:5}:
                     {color:'#f00',weight:4,dashArray:'5,5'};
      L.geoJSON(r,{style}).addTo(map);
    });
    showSummary(routes);
    drawDistanceChart(routes[bestIdx]);
    await insertRestStops(routes[bestIdx]);
  } else {
    // 単一路線
    const url = `${ORS_ROOT}/v2/directions/${profile}/geojson`;
    const res = await fetch(PROXY+url,{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':apiKey},
      body: JSON.stringify({coordinates:coords,extra_info:["steepness"]})
    });
    const data = await res.json();
    const route = data.features[0];
    L.geoJSON(route,{style:{color:'#00f',weight:5}}).addTo(map);
    showSummary([route]);
    drawDistanceChart(route);
    await insertRestStops(route);
  }

  // 出発・目的・経由地マーカー
  points.forEach((p,i)=>{
    const iconUrl = (i===0)?'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png':
                      (i===points.length-1)?'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png':
                      'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png';
    L.marker([p.lat,p.lon],{icon:new L.Icon({iconUrl,iconSize:[32,32],iconAnchor:[16,32]})}).addTo(map);
  });
}

/* ===== 8. 坂スコア算出 ===== */
function calcSteepnessScore(steepValues){
  // steepValues: [[index, class], ...]
  return steepValues.reduce((acc,cur)=> acc + Math.abs(cur[1]),0);
}

/* ===== 9. 休憩地点挿入 ===== */
async function insertRestStops(route){
  if (!route || !$('restInt').value) return;
  const intervalMin = +$('restInt').value;
  const coords = route.geometry.coordinates;
  const times = [];
  const speed = 15/3.6; // 15km/h → m/s仮定
  let totalDist=0;
  for(let i=1;i<coords.length;i++){
    const d = L.latLng(coords[i-1][1],coords[i-1][0])
               .distanceTo([coords[i][1],coords[i][0]]);
    totalDist+=d;
    times[i]= totalDist / speed;
  }
  const totalTime = times[times.length-1];
  const restTimes = [];
  for(let t=intervalMin*60; t<totalTime; t+=intervalMin*60){
    restTimes.push(t);
  }

  restLayer = L.layerGroup().addTo(map);
  $('progressStatus').textContent = '休憩検索中…';

  for(const rt of restTimes){
    // 最も近いインデックス
    let idx=0;
    let diff=Infinity;
    for(let i=0;i<times.length;i++){
      const d = Math.abs(times[i]-rt);
      if(d<diff){diff=d; idx=i;}
    }
    const target = coords[idx];
    const pois = await fetchRestPOI(target);
    if(pois.length>0){
      pois.forEach(f=>{
        L.marker([f.geometry.coordinates[1],f.geometry.coordinates[0]],{
          icon:new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png',
          iconSize:[32,32],iconAnchor:[16,32]})
        }).bindPopup(`${f.properties.name||'POI'} / ${f.properties.category} / Δ${Math.round(diff/60)}分`)
          .addTo(restLayer);
      });
    } else {
      L.marker([target[1],target[0]],{
        icon:new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/ltblue-dot.png',
        iconSize:[32,32],iconAnchor:[16,32]})
      }).bindPopup(`休憩候補なし / Δ${Math.round(diff/60)}分`)
        .addTo(restLayer);
    }
    $('progressStatus').textContent = `休憩探索 ${rt/60}分地点完了`;
  }
  $('progressStatus').textContent = '休憩探索完了';
}
async function fetchRestPOI(coord){
  const url = PROXY + ORS_ROOT + '/pois';
  const body = {
    request:'pois',
    geometry:{geojson:{type:'Point',coordinates:coord},buffer:REST_RADIUS},
    filters:{category_ids:REST_POI_IDS},
    limit:5
  };
  const res = await fetch(url,{
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':apiKey},
    body:JSON.stringify(body)
  });
  if(!res.ok) return [];
  return (await res.json()).features || [];
}

/* ===== 10. サマリー表示 ===== */
function showSummary(routes){
  if(!routes||routes.length===0) return;
  const r = routes[0].properties.summary;
  let html = `距離: ${(r.distance/1000).toFixed(1)} km / 時間: ${(r.duration/60).toFixed(0)} 分`;
  if(routes.length>1){
    const r2 = routes.find((_,i)=>i!==0).properties.summary;
    html += `<br>坂多ルート比較: ${(r2.distance/1000).toFixed(1)} km / ${(r2.duration/60).toFixed(0)} 分`;
  }
  $('summary').innerHTML = html;
}

/* ===== 11. 区間距離グラフ＋PNG/CSV ===== */
function drawDistanceChart(route){
  if(!route) return;
  const coords = route.geometry.coordinates;
  const distArr = [];
  for(let i=1;i<coords.length;i++){
    const d = L.latLng(coords[i-1][1],coords[i-1][0])
               .distanceTo([coords[i][1],coords[i][0]]);
    distArr.push(d);
  }
  const ctx = $('distanceChart').getContext('2d');
  if(window.distChart) window.distChart.destroy();
  window.distChart = new Chart(ctx,{
    type:'bar',
    data:{labels:distArr.map((_,i)=>i+1),datasets:[{label:'区間距離(m)',data:distArr}]},
    options:{responsive:true}
  });
  $('downloadPng').onclick=()=>{
    const a = document.createElement('a');
    a.href = window.distChart.toBase64Image();
    a.download = `距離分布_${new Date().toISOString().split('T')[0]}.png`;
    a.click();
  };
  $('downloadCsv').onclick=()=>{
    const mean = distArr.reduce((a,b)=>a+b,0)/distArr.length;
    const mse  = distArr.reduce((a,b)=>a+(b-mean)**2,0)/distArr.length;
    let csv = '区間,距離(m)\n';
    distArr.forEach((d,i)=>{csv += `${i+1},${d}\n`;});
    csv += `平均,${mean}\nMSE,${mse}\n`;
    const blob = new Blob(["\uFEFF"+csv],{type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `ルートスコア_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };
}

/* ===== 12. レイヤークリア ===== */
function clearLayers(){
  if(routeLayer) map.removeLayer(routeLayer);
  if(poiLayer)   map.removeLayer(poiLayer);
  if(restLayer)  map.removeLayer(restLayer);
}
</script>
</body>
</html>
