<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>等間隔休憩（コンビニ/スーパー/ドラッグストア/道の駅限定版）</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  #map{height:500px;}
  #controls{margin:10px 0;display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
  #searchResults{max-height:150px;overflow-y:auto;list-style:none;border:1px solid #ccc;}
  #searchResults li:hover{background:#eee;cursor:pointer;}
  #pointList{list-style:none;padding:0;}
  #pointList li{padding:4px;border:1px solid #ccc;margin-bottom:4px;background:#fafafa;cursor:move;display:flex;justify-content:space-between;align-items:center;}
  #pointList li span.role-name{flex-grow:1;}
  #distanceChartContainer{display:none;margin-top:20px;background:#fff;padding:10px;}
  #progressStatus{margin:6px 0;color:#ff9900;font-weight:bold;min-height:1.5em;}
  .legend-steep{display:inline-block;border-radius:8px;padding:2px 10px;margin-right:10px;}
  .legend-blue{background:#6ab4ff;color:#003366;}
  .legend-red{background:#ffaaa2;color:#7a001b;}
  .legend-orange{background:#ffd966;color:#a87d00;}
  .legend-gray{background:#bcbcbc;color:#333;}
</style>
</head>
<body style="background:#fff;">

<h2>等間隔休憩 + 標高考慮ルート案内<br><small>（コンビニ／スーパー／ドラッグストア／道の駅対応）</small></h2>

<!-- ---------- 操作パネル ---------- -->
<div id="controls">
  <input id="placeInput" type="text" placeholder="地名・住所を入力" style="width:240px;">
  <button id="clearPlaceInputBtn">×</button>
  <button id="searchPlaceBtn">地名検索</button>
  <label><input type="checkbox" id="nearbyOnlyCheckbox"> 近くの場所のみ検索</label>
  <button id="addCurrentBtn">現在地を追加</button>
  <button id="toggleRealTimeBtn">リアルタイム現在地更新 OFF</button>
  <button id="drawRouteBtn">坂ルート表示</button>

  <!-- 休憩：時間 or 距離 -->
  <label style="display:flex;align-items:center;gap:4px;">
    <input type="checkbox" id="restCheckbox">
    <input type="number" id="restTimeInput" value="60" min="1" style="width:60px;" disabled> 分ごと
  </label>
  <label style="display:flex;align-items:center;gap:4px;">
    <input type="checkbox" id="distanceModeCheckbox">
    <input type="number" id="restDistInput" value="2" min="0.1" step="0.1" style="width:60px;" disabled> kmごと
  </label>

  <button id="downloadCsvBtn">CSV</button>
  <button id="downloadGraphBtn">距離グラフ</button>

  <select id="profileSelect">
    <option value="foot-walking">徒歩</option>
    <option value="driving-car">車</option>
    <option value="cycling-regular">自転車（一般）</option>
    <option value="cycling-road" selected>ロードバイク</option>
    <option value="cycling-mountain">MTB</option>
    <option value="cycling-electric">E-Bike</option>
  </select>
  <div id="routeInfo" style="margin-left:8px;"></div>
</div>

<!-- 凡例 -->
<div>
  <span class="legend-steep legend-blue">青：坂少</span>
  <span class="legend-steep legend-red">赤：坂多</span>
  <span class="legend-steep legend-orange">黄：POI休憩</span>
  <span class="legend-steep legend-gray">灰：仮休憩</span>
</div>

<div id="progressStatus"></div>
<h3>登録地点リスト（ドラッグ並び替え可）</h3>
<ul id="pointList"></ul>
<ul id="searchResults"></ul>
<div id="map"></div>

<!-- 距離グラフ -->
<div id="distanceChartContainer">
  <canvas id="distanceChart" width="800" height="400" style="background:#fff;"></canvas>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/sortablejs@latest/Sortable.min.js"></script>

<script>
/* ========= 0. 定数 ========= */
const apiKey            = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';      // ←★自分の ORS API キー
const POI_BUFFER_M      = 800;                 // 検索半径 [m]
const MAX_LATERAL_M     = 200;                 // ルートからの横ズレ許容 [m]
const SEG_WINDOW        = 8;                   // ターゲット前後の頂点幅

/* 休憩に採用するカテゴリ ID */
const REST_POI_CATEGORIES = [
  451,  // shop=convenience     (コンビニ)
  518,  // shop=supermarket     (スーパー)
  443,  // shop=chemist         (ドラッグストア)
  208,  // amenity=pharmacy     (調剤薬局等)
  623   // information=roadside_station (道の駅)
];

/* 重み & 標高差考慮 */
const W_TIME = 3, W_DIST = 1, W_ASC = -1, ASC_LOOKBACK = 5;

/* ========= 1. 地図 ========= */
const map = L.map('map').setView([34.0689,134.5594], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

const iconStart=new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/green-dot.png',iconSize:[32,32],iconAnchor:[16,32]});
const iconVia  =new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png', iconSize:[32,32],iconAnchor:[16,32]});
const iconEnd  =new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png',  iconSize:[32,32],iconAnchor:[16,32]});
const iconRest =new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/orange-dot.png',iconSize:[32,32],iconAnchor:[16,32]});
const iconRestG=new L.Icon({iconUrl:'https://maps.gstatic.com/mapfiles/ms2/micons/ltgray-dot.png',iconSize:[32,32],iconAnchor:[16,32]});

/* ========= 2. util ========= */
const $ = id=>document.getElementById(id);
const toRad=d=>d*Math.PI/180;
const haversine=(lat1,lon1,lat2,lon2)=>{
  const R=6371000;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
};
const interp=(a,b,t)=>[a[0]+t*(b[0]-a[0]),a[1]+t*(b[1]-a[1]),a[2]+t*(b[2]-a[2])];
function ascendPrev(coords,idx,n=ASC_LOOKBACK){
  let asc=0; const s=Math.max(1,idx-n+1);
  for(let i=s;i<=idx;i++){const up=coords[i][2]-coords[i-1][2];if(up>0)asc+=up;}
  return asc;
}
const catLabel=ids=>{
  if(ids.includes(451)) return 'コンビニ';
  if(ids.includes(518)) return 'スーパー';
  if(ids.includes(443) || ids.includes(208)) return 'ドラッグストア';
  if(ids.includes(623)) return '道の駅';
  return 'POI';
};

/* ========= 3. 状態 ========= */
let points=[], markers=[], restMarkers=[], routeLayers=[];
let routeDistances=[], routeLabels=[];

/* ========= 4. UI 切替 ========= */
restCheckbox.onchange   = ()=>{restTimeInput.disabled=!restCheckbox.checked;};
distanceModeCheckbox.onchange=()=>{
  restDistInput.disabled=!distanceModeCheckbox.checked;
  restCheckbox.checked = !distanceModeCheckbox.checked;
  restTimeInput.disabled=!restCheckbox.checked;
};

/* ========= 5. マーカー & リスト ========= */
function updateMarkers(){
  [...markers,...restMarkers].forEach(m=>map.removeLayer(m));
  markers.length=restMarkers.length=0;
  points.forEach((p,i)=>{
    let ic=iconVia;
    if(i===0)ic=iconStart; else if(i===points.length-1)ic=iconEnd;
    else if(p.name?.startsWith('休憩'))ic=p.isPOI?iconRest:iconRestG;
    const mk=L.marker([p.lat,p.lng],{icon:ic}).addTo(map).bindPopup(p.name||p.lat.toFixed(5));
    (ic===iconRest||ic===iconRestG?restMarkers:markers).push(mk);
  });
}
function refreshList(){
  pointList.innerHTML='';
  points.forEach((p,i)=>{
    const li=document.createElement('li');li.className='draggable';
    const sp=document.createElement('span');sp.className='role-name';
    let pre=i===0?'出発: ':i===points.length-1?'目的: ':'経由: ';
    if(p.name?.startsWith('休憩'))pre='休憩: ';
    sp.textContent=pre+(p.name?.replace(/^休憩:\s?/,'')||`(${p.lat.toFixed(4)},${p.lng.toFixed(4)})`);
    const bt=document.createElement('button');bt.textContent='×';
    bt.onclick=()=>{points.splice(i,1);updateMarkers();refreshList();};
    li.appendChild(sp);li.appendChild(bt);pointList.appendChild(li);
  });
}
new Sortable(pointList,{animation:150,onEnd:()=>{
  const arr=[];
  [...pointList.children].forEach(li=>{
    const txt=li.querySelector('.role-name').textContent.replace(/^(出発|目的|経由|休憩): /,'');
    const m=points.find(p=>(p.name?.replace(/^休憩:\s?/,'')||`(${p.lat.toFixed(4)},${p.lng.toFixed(4)})`)===txt);
    if(m)arr.push(m);
  });
  points=arr;updateMarkers();refreshList();
}});

/* ========= 6. POI 取得 (カテゴリ制限) ========= */
async function fetchPois(coords){
  const body={request:'pois',
              geometry:{geojson:{type:'LineString',coordinates:coords}},
              buffer:POI_BUFFER_M,limit:100,
              filters:{category_ids:REST_POI_CATEGORIES}};
  const res=await fetch('https://api.openrouteservice.org/pois',{
    method:'POST',headers:{'Content-Type':'application/json','Authorization':apiKey},
    body:JSON.stringify(body)});
  if(!res.ok)return[];
  const js=await res.json();
  return js.features;
}
async function fetchPoisWithSegIdx(coords){
  const feats=await fetchPois(coords);
  return feats.map(f=>{
    let idx=0,min=1e9;
    coords.forEach((c,i)=>{
      const d=haversine(c[1],c[0],f.geometry.coordinates[1],f.geometry.coordinates[0]);
      if(d<min){min=d;idx=i;}
    });
    return{
      id:f.id||`${f.geometry.coordinates[0]}_${f.geometry.coordinates[1]}`,
      lon:f.geometry.coordinates[0],lat:f.geometry.coordinates[1],
      catIds:f.properties.category_ids||[],name:f.properties.name||'',segIdx:idx
    };
  });
}

/* ========= 7. 休憩自動挿入 ========= */
async function insertRests(feature){
  const coords3d=feature.geometry.coordinates;
  /* 累積距離・時間 */
  const cumDist=[0]; for(let i=1;i<coords3d.length;i++)
    cumDist.push(cumDist.at(-1)+haversine(coords3d[i-1][1],coords3d[i-1][0],coords3d[i][1],coords3d[i][0]));
  const totalDist=cumDist.at(-1);
  const totalSec =feature.properties.summary.duration;
  const cumTime=cumDist.map(d=>totalSec*(d/totalDist));

  /* ターゲット生成 */
  const targets=[];
  if(distanceModeCheckbox.checked){
    const dInt=Number(restDistInput.value||2)*1000;
    for(let d=dInt;d<totalDist;d+=dInt)targets.push({dist:d,sec:totalSec*(d/totalDist)});
  }else{
    const sInt=Number(restTimeInput.value||60)*60;
    for(let t=sInt;t<totalSec;t+=sInt)targets.push({sec:t,dist:totalDist*(t/totalSec)});
  }
  if(!targets.length)return;

  const pois=await fetchPoisWithSegIdx(coords3d);
  const used=new Set(),restPts=[];

  for(let k=0;k<targets.length;k++){
    const tIdx=cumTime.findIndex(t=>t>=targets[k].sec);
    const goal=interp(coords3d[tIdx-1],coords3d[tIdx],(targets[k].sec-cumTime[tIdx-1])/(cumTime[tIdx]-cumTime[tIdx-1]));
    const goalLat=goal[1],goalLon=goal[0],asc=ascendPrev(coords3d,tIdx);

    /* 近傍候補 */
    const cand=pois.filter(p=>!used.has(p.id)&&Math.abs(p.segIdx-tIdx)<=SEG_WINDOW);
    let best=null,bScore=1e12;
    const maxDiff=(distanceModeCheckbox.checked?Number(restDistInput.value)*60:Number(restTimeInput.value)*60)*0.4;

    for(const p of cand){
      const lateral=haversine(goalLat,goalLon,p.lat,p.lon); if(lateral>MAX_LATERAL_M)continue;
      const segDist=haversine(coords3d[p.segIdx][1],coords3d[p.segIdx][0],coords3d[p.segIdx+1][1],coords3d[p.segIdx+1][0])||1;
      const along =haversine(coords3d[p.segIdx][1],coords3d[p.segIdx][0],p.lat,p.lon);
      const passSec=cumTime[p.segIdx]+(along/segDist)*(cumTime[p.segIdx+1]-cumTime[p.segIdx]);
      const diff=Math.abs(passSec-targets[k].sec); if(diff>maxDiff)continue;
      const score=W_TIME*diff+W_DIST*lateral+W_ASC*asc;
      if(score<bScore){bScore=score;best={...p,lateral,diff,asc};}
    }

    if(best){
      used.add(best.id);
      restPts.push({
        lat:best.lat,lng:best.lon,isPOI:true,
        name:`休憩${k+1}: ${best.name||'施設名なし'}（${catLabel(best.catIds)}）`
           +`（ズレ ${(best.diff/60).toFixed(1)}分/${best.lateral.toFixed(0)}m｜登り ${best.asc.toFixed(0)}m）`
      });
    }else{
      restPts.push({
        lat:goalLat,lng:goalLon,isPOI:false,
        name:`休憩${k+1}: 仮休憩 [${goalLat.toFixed(5)},${goalLon.toFixed(5)}]`
      });
    }
    progressStatus.textContent=`休憩計算 ${k+1}/${targets.length}`;
    await new Promise(r=>setTimeout(r,25));
  }

  points=[points[0],...restPts,points.at(-1)];
  updateMarkers();refreshList();
  progressStatus.textContent='休憩地点追加完了';
}

/* ========= 8. ルート計算 ========= */
async function drawRoute(){
  if(points.length<2)return alert('2地点以上登録してください');
  const coords=points.map(p=>[p.lng,p.lat]);
  const first=await fetch(`https://api.openrouteservice.org/v2/directions/${profileSelect.value}/geojson?elevation=true`,
    {method:'POST',headers:{'Content-Type':'application/json','Authorization':apiKey},
     body:JSON.stringify({coordinates:coords})});
  if(!first.ok)return alert('ルート取得失敗');
  const feat=(await first.json()).features[0];

  /* 休憩挿入 */
  if(restCheckbox.checked||distanceModeCheckbox.checked)await insertRests(feat);

  /* 本ルート再計算 */
  const coords2=points.map(p=>[p.lng,p.lat]);
  const body=points.length===2
    ?{coordinates:coords2,alternative_routes:{share_factor:0.6,target_count:3},extra_info:["steepness"]}
    :{coordinates:coords2,extra_info:["steepness"]};
  const res=await fetch(`https://api.openrouteservice.org/v2/directions/${profileSelect.value}/geojson?elevation=true`,
    {method:'POST',headers:{'Content-Type':'application/json','Authorization':apiKey},body:JSON.stringify(body)});
  if(!res.ok)return alert('再計算失敗');
  const best=res.json().then(js=>js.features[0]);

  best.then(route=>{
    routeLayers.forEach(l=>map.removeLayer(l));routeLayers.length=0;
    const l=L.geoJSON(route,{style:{color:'#0095ff',weight:6}}).addTo(map);routeLayers.push(l);
    map.fitBounds(l.getBounds());

    /* グラフ */
    routeDistances=[];routeLabels=[];
    route.geometry.coordinates.forEach((c,i,arr)=>{if(i===0)return;
      routeDistances.push(haversine(arr[i-1][1],arr[i-1][0],c[1],c[0]));
      routeLabels.push([`P${i}`,`P${i+1}`]);
    });
    showChart(route.properties.summary);
  });
}

/* ========= 9. Chart ========= */
function showChart(summary){
  distanceChartContainer.style.display='block';
  if(window.distanceChart)window.distanceChart.destroy();
  window.distanceChart=new Chart(distanceChart.getContext('2d'),{
    type:'bar',data:{
      labels:routeLabels.map((l,i)=>`区間${i+1}`),
      datasets:[{label:'距離(km)',data:routeDistances.map(d=>(d/1000).toFixed(2)),
                 backgroundColor:'rgba(75,192,192,0.6)'}]},options:{
      responsive:true,plugins:{legend:{display:true}},
      scales:{y:{title:{display:true,text:'距離 (km)'}}}});
  routeInfo.innerHTML=`距離 ${(summary.distance/1000).toFixed(1)} km / 時間 ${(summary.duration/60).toFixed(1)} 分`;
}

/* ========= 10. ジオコーディング ========= */
function searchPlaces(q){
  let url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=10&addressdetails=1`;
  if(nearbyOnlyCheckbox.checked&&navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat,longitude:lon}=pos.coords,d=0.05;
      url+=`&viewbox=${lon-d},${lat+d},${lon+d},${lat-d}&bounded=1`;fetchList(url);
    });
  }else fetchList(url);
}
function fetchList(url){
  fetch(url).then(r=>r.json()).then(d=>{
    searchResults.innerHTML='';
    if(!d.length)return searchResults.textContent='該当なし';
    d.forEach(p=>{
      const li=document.createElement('li');li.textContent=p.display_name;
      li.onclick=()=>{points.push({lat:+p.lat,lng:+p.lon,name:p.display_name});
                      updateMarkers();refreshList();placeInput.value='';searchResults.innerHTML='';};
      searchResults.appendChild(li);
    });
  });
}

/* ========= 11. イベント ========= */
searchPlaceBtn.onclick =()=>{const q=placeInput.value.trim();if(q)searchPlaces(q);};
clearPlaceInputBtn.onclick=()=>{placeInput.value='';searchResults.innerHTML='';};
addCurrentBtn.onclick=()=>{
  navigator.geolocation.getCurrentPosition(p=>{
    points.push({lat:p.coords.latitude,lng:p.coords.longitude,name:'現在地'});
    updateMarkers();refreshList();
  });
};
drawRouteBtn.onclick =()=>drawRoute();

/* DL ボタン（CSV/PNG）は前回と同等のまま――省略可 */
</script>
</body>
</html>
