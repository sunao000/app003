<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>等間隔休憩ルート案内 – 拡張版 (最短距離)</title>

  <!-- Leaflet / Sortable / Chart.js -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{font-family:sans-serif;margin:0;padding:0}
    #map{height:500px;width:100%}
    #controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
    #pointList{list-style:none;margin:0;padding:0}
    #pointList li{display:flex;align-items:center;justify-content:space-between;padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move}
    #searchResults{list-style:none;margin:4px 0 0 0;padding:0;max-height:200px;overflow-y:auto;border:1px solid #ccc;background:#fff;position:absolute;z-index:1000;width:260px}
    #searchResults li{padding:4px 8px;cursor:pointer}
    #searchResults li:hover{background:#e0e0e0}
    #summary{padding:8px;background:#fafafa;border-top:1px solid #ddd;font-size:0.9rem}
    #progressStatus{margin-left:8px;font-size:0.9rem;color:#666}
    canvas{max-width:100%}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin:4px 0}
    .legend-item{display:flex;align-items:center;gap:4px;font-size:0.8rem}
    .legend-color{width:14px;height:14px;border-radius:50%}
  </style>
</head>
<body>

<!-- ▼ 操作パネル -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:240px">
  <button id="searchBtn">検索</button>
  <button id="locBtn">現在地追加</button>
  <label><input type="checkbox" id="nearbyOnly"> 近くの場所のみ検索</label>
  <br>
  <select id="profileSelect">
    <option value="foot-walking">徒歩</option>
    <option value="driving-car">車</option>
    <option value="cycling-regular" selected>自転車（通常）</option>
    <option value="cycling-road">自転車（ロード）</option>
    <option value="cycling-mountain">自転車（MTB）</option>
  </select>
  <button id="drawBtn">ルート表示</button>
  <label><input type="checkbox" id="trackToggle"> 現在地トラッキング</label>
  <label><input type="checkbox" id="timeMode" checked> 休憩 <input id="timeInt" type="number" value="60" style="width:60px"> 分ごと</label>
  <span id="progressStatus"></span>
</div>

<!-- ▼ 検索結果ポップアップ -->
<ul id="searchResults" hidden></ul>

<!-- ▼ 登録地点リスト -->
<ul id="pointList"></ul>

<!-- ▼ 地図 -->
<div id="map"></div>

<!-- ▼ サマリー -->
<div id="summary">
  <div id="routeInfo">距離・時間を表示</div>
  <div class="legend">
    <div class="legend-item"><span class="legend-color" style="background:#00a000"></span> 出発地</div>
    <div class="legend-item"><span class="legend-color" style="background:#d00000"></span> 目的地</div>
    <div class="legend-item"><span class="legend-color" style="background:#0066ff"></span> 経由地</div>
    <div class="legend-item"><span class="legend-color" style="background:#ff9900"></span> 実 POI 休憩</div>
    <div class="legend-item"><span class="legend-color" style="background:#999999"></span> 仮休憩</div>
  </div>
  <button id="csvBtn">CSV ダウンロード</button>
  <button id="pngBtn">距離分布 PNG</button>
</div>

<!-- ▼ 距離グラフ -->
<canvas id="distChart"></canvas>

<script>
/******************** 0. 定数 ********************/
const apiKey   = '5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';// ←★ORS API キーをここに
const PROXY    = 'https://corsproxy.io/?';
const ORS_ROOT = 'https://api.openrouteservice.org';
const POI_CATS = [533,532,414];// 休憩候補カテゴリ
const POI_RADIUS = 1000; // m
/******************** 1. 地図 ********************/
const map = L.map('map').setView([35.681236,139.767125],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'©OpenStreetMap'}).addTo(map);
/******************** 2. アイコン定義 ********************/
function icon(color){return new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${color}-dot.png`,iconSize:[32,32],iconAnchor:[16,32]});}
const ICONS = {start:icon('green'),goal:icon('red'),via:icon('blue'),poi:icon('orange'),dummy:icon('grey')};
/******************** 3. 状態 ********************/
let pts = [];            // {name,lat,lon,type}
let routeLayer=null, altLayer=null, poiLayer=null;
let trackId=null, lastPos=null;
let distChart=null;      // Chart.js インスタンス
/******************** 4. ユーティリティ ********************/
function $(id){return document.getElementById(id);} // 短縮
function haversine(lat1,lon1,lat2,lon2){const R=6371000;
  const toR=d=>d*Math.PI/180;const dLat=toR(lat2-lat1),dLon=toR(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}// m
function formatDist(m){return (m/1000).toFixed(2)+' km';}
function formatDur(sec){return Math.round(sec/60)+' 分';}
/******************** 5. 検索 & 地点登録 ********************/
searchBtn.onclick=()=>{const q=placeInput.value.trim();if(!q)return;geoSearch(q);};
async function geoSearch(q){const base=`https://nominatim.openstreetmap.org/search?format=json&limit=10&addressdetails=1&q=`+encodeURIComponent(q);
  let url=base;
  if(nearbyOnly.checked&&lastPos){const {coords}=lastPos;const d=0.05; // 約5km四方
    const left=coords.longitude-d,right=coords.longitude+d,top=coords.latitude+d,bottom=coords.latitude-d;
    url+=`&viewbox=${left},${top},${right},${bottom}&bounded=1`;}
  const res=await fetch(url);const data=await res.json();renderSearchResults(data);
}
function renderSearchResults(arr){const ul=$("searchResults");ul.innerHTML='';if(!arr.length){ul.hidden=true;return;} ul.hidden=false;
  arr.forEach(o=>{const li=document.createElement('li');li.textContent=o.display_name;li.onclick=()=>{addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});ul.hidden=true;placeInput.value='';};ul.appendChild(li);});}
function addPoint(p){p.type=pts.length===0?'start':'';pts.forEach(pt=>{if(pt.type==='goal')pt.type='via';}); // 既存 goal を viaへ
  pts.push(p);if(pts.length>1)pts[pts.length-1].type='goal';refreshList();}
/******************** 6. Sortable.js で並び替え ********************/
const sortable = new Sortable(pointList,{animation:150,onEnd:()=>{pts=Array.from(pointList.children).map(li=>li._data);if(pts[0])pts[0].type='start';if(pts.length>1)pts[pts.length-1].type='goal';refreshList();}});
function refreshList(){pointList.innerHTML='';pts.forEach((p,i)=>{const li=document.createElement('li');li.textContent=p.name;li._data=p;
    const del=document.createElement('button');del.textContent='×';del.onclick=e=>{e.stopPropagation();pts.splice(i,1);if(pts[0])pts[0].type='start';if(pts.length>1)pts[pts.length-1].type='goal';refreshList();};
    li.appendChild(del);pointList.appendChild(li);});}
/******************** 7. 現在地追加 & トラッキング ********************/
locBtn.onclick=()=>{navigator.geolocation.getCurrentPosition(pos=>{lastPos=pos;addPoint({name:'現在地',lat:pos.coords.latitude,lon:pos.coords.longitude});});};
trackToggle.onchange=()=>{if(trackToggle.checked){if(trackId)return;trackId=navigator.geolocation.watchPosition(pos=>{
  if(!lastPos){lastPos=pos;return;}const d=haversine(lastPos.coords.latitude,last
