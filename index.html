<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>自転車ルート比較＋休憩（統合版 Step1）</title>

<!-- ライブラリ -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
body{margin:0;font-family:system-ui,sans-serif}
#map{height:500px;width:100%}
#controls{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#f7f7f7}
#pointList{list-style:none;margin:0;padding:0}
#pointList li{padding:4px 8px;border:1px solid #ccc;background:#fafafa;margin-bottom:4px;cursor:move;display:flex;justify-content:space-between}
button.del{background:#d9534f;color:#fff;border:none;border-radius:4px;padding:0 6px;font-size:12px}
</style>
</head>
<body>

<!-- 操作パネル -->
<div id="controls">
  <input id="placeInput" placeholder="地名・住所" style="width:260px">
  <button id="searchBtn">検索</button>
  <button id="locBtn">現在地追加</button>
  <button id="drawBtn">ルート計算</button>
</div>

<!-- 地点リストと地図 -->
<ul id="pointList"></ul>
<div id="map"></div>

<script>
/* ====== 初期化 ====== */
let map, pts=[], markerLayer, routeLayer;
function $(id){return document.getElementById(id);}

window.addEventListener('DOMContentLoaded',()=>{
  // Leaflet地図
  map=L.map('map').setView([34.07,134.55],11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              {attribution:'©OpenStreetMap'}).addTo(map);

  $('searchBtn').onclick=()=>{if($('placeInput').value) nomSearch($('placeInput').value);};
  $('locBtn').onclick=()=>navigator.geolocation.getCurrentPosition(
      p=>addPoint({name:'現在地',lat:p.coords.latitude,lon:p.coords.longitude}),
      ()=>alert('現在地取得失敗'));
  $('drawBtn').onclick=drawRoutes;

  // 並べ替え
  new Sortable($('pointList'),{
    animation:150,
    onEnd:()=>{pts=Array.from($('pointList').children).map(li=>pts[li.dataset.idx]);fixType();drawList();}
  });
});

/* ====== 地点管理 ====== */
function addPoint(p){
  p.type=pts.length?'':'start';
  pts.forEach(d=>{if(d.type==='goal')d.type='via';});
  pts.push(p);
  if(pts.length>1) pts[pts.length-1].type='goal';
  drawList();
}
function fixType(){ if(pts[0]) pts[0].type='start'; if(pts.length>1) pts[pts.length-1].type='goal'; }
function drawList(){
  const ul=$('pointList'); ul.innerHTML='';
  pts.forEach((p,i)=>{
    const li=document.createElement('li'); li.dataset.idx=i;
    li.innerHTML=`${p.name}<button class="del">×</button>`;
    li.querySelector('.del').onclick=()=>{pts.splice(i,1); fixType(); drawList();};
    ul.appendChild(li);
  });
}

/* ====== 検索 ====== */
async function nomSearch(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&limit=10&q=${encodeURIComponent(q)}`;
  const arr=await (await fetch(url)).json();
  if(!arr.length){alert('見つかりません');return;}
  const o=arr[0];
  addPoint({name:o.display_name,lat:+o.lat,lon:+o.lon});
}

/* ====== ルート描画(ダミー) ====== */
function drawRoutes(){
  if(pts.length<2){alert('2地点以上登録してください');return;}
  alert('ここで後続ステップのORSルート計算を行います');
}
</script>
</body>
</html>
