<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>等間隔休憩ルート案内</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  #map{height:500px}
  #controls{margin:10px 0;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  #pointList{list-style:none;padding:0}
  #pointList li{padding:4px;border:1px solid #ccc;margin-bottom:4px;background:#fafafa;
    display:flex;justify-content:space-between;align-items:center}
  #pointList li span{flex-grow:1}
</style>
</head>
<body>

<!-- ▼ 操作パネル -->
<div id="controls">
  <input id="placeInput" placeholder="地名">
  <button id="addBtn">地点追加</button>
  <button id="drawBtn">ルート表示</button>
</div>

<ul id="pointList"></ul>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ===== 設定 ===== */
const apiKey='5b3ce3597851110001cf62481af47799d9c344bf86dd4b340f9f9ff9';               /* ←★ここを変更 */
const POI_IDS=[451,518,443,208,623];       /* int 配列：コンビニ／スーパー／ドラッグストア／薬局／道の駅 */
const POI_BUFFER=800;

/* ===== 地図 ===== */
const map=L.map('map').setView([34.07,134.56],9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
 {attribution:'©OpenStreetMap'}).addTo(map);
const mkI=c=>new L.Icon({iconUrl:`https://maps.gstatic.com/mapfiles/ms2/micons/${c}.png`,
  iconSize:[32,32],iconAnchor:[16,32]});
const I={st:mkI('green-dot'),via:mkI('blue-dot'),ed:mkI('red-dot'),o:mkI('orange-dot'),g:mkI('ltgray-dot')};

/* ===== util ===== */
const $=id=>document.getElementById(id);
const rad=d=>d*Math.PI/180;
const hav=(a,b,c,d)=>{const R=6371000,dl=rad(c-a),dlo=rad(d-b),
 s=Math.sin(dl/2)**2+Math.cos(rad(a))*Math.cos(rad(c))*Math.sin(dlo/2)**2;
 return R*2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));};

/* ===== 状態 ===== */
let pts=[],routeLayer=null;

/* ===== UI ===== */
function renderList(){
  pointList.innerHTML='';
  pts.forEach((p,i)=>{
    const li=document.createElement('li');
    const sp=document.createElement('span');sp.textContent=p.name;
    const bt=document.createElement('button');bt.textContent='×';
    bt.onclick=()=>{pts.splice(i,1);renderList();};
    li.appendChild(sp);li.appendChild(bt);pointList.appendChild(li);
  });
}
addBtn.onclick=()=>{const q=placeInput.value.trim();if(!q)return;
  pts.push({name:q,lat:34.07+Math.random(),lon:134.56+Math.random()});
  renderList();placeInput.value='';
};

/* ===== POI 取得 ===== */
async function fetchPois(coords){
  const body={
    request:'pois',
    geometry:{
      geojson:{type:'LineString',coordinates:coords},
      buffer:POI_BUFFER            /* ← geometry 内に buffer を配置 */
    },
    filters:{category_ids:POI_IDS}, /* 数値配列 */
    limit:100
  };
  const res=await fetch('https://api.openrouteservice.org/pois',
    {method:'POST',headers:{'Content-Type':'application/json','Authorization':apiKey},
     body:JSON.stringify(body)});
  if(!res.ok){console.error('/pois',res.status,await res.text());throw new Error('POI fetch fail');}
  return (await res.json()).features;
}

/* ===== ルート描画 ===== */
async function draw(){
  if(pts.length<2){alert('最低 2 点登録してください');return;}
  const coords=pts.map(p=>[p.lon,p.lat]);
  /* メインルート */
  const r=await fetch(`https://api.openrouteservice.org/v2/directions/cycling-road/geojson`,
   {method:'POST',headers:{'Content-Type':'application/json','Authorization':apiKey},
    body:JSON.stringify({coordinates:coords})});
  if(!r.ok){alert('ルート取得失敗');return;}
  const route=(await r.json()).features[0];
  if(routeLayer)map.removeLayer(routeLayer);
  routeLayer=L.geoJSON(route,{style:{color:'#09f',weight:6}}).addTo(map);
  map.fitBounds(routeLayer.getBounds());

  /* POI テスト表示（オレンジ） */
  const pois=await fetchPois(coords);
  pois.forEach(f=>{
    L.marker([f.geometry.coordinates[1],f.geometry.coordinates[0]],{icon:I.o})
     .addTo(map).bindPopup(f.properties.name||'POI');
  });
}

drawBtn.onclick=draw;
</script>
</body>
</html>
